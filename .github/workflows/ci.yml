name: CI

on:
  pull_request:
  push:
    branches:
      # Also run on main branch to have cache on default branch
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      changed_files_node_all: ${{ steps.changed_files.outputs.node_all_any_changed }}
      changed_files_node_lint: ${{ steps.changed_files.outputs.node_lint_any_changed }}
      changed_files_renovate: ${{ steps.changed_files.outputs.renovate_any_changed }}
    steps:
      - uses: actions/checkout@v4

      - name: Get all test, doc and src files that have changed
        id: changed_files
        uses: tj-actions/changed-files@v44
        with:
          files_yaml: |
            node_all:
              - tsconfig.json
              - package.json
              - package-lock.json
              - .tool-versions
              - src/**
            node_lint:
              - biome.json
            renovate:
              - renovate.json5

      - name: Display changed files
        run: |
          echo '${{ toJson(steps.changed_files.outputs) }}'
        
  node_lint:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_node_all == 'true' || needs.setup.outputs.changed_files_node_lint == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - run: npm ci

      - name: Run lint
        run: npm run lint

  node_test:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_node_all == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Restore failed tests
        if: github.run_attempt > 1 && github.ref_name != 'main'
        uses: actions/cache/restore@v4
        with:
          path: vitest_failed_testfiles.txt
          key: failed-tests-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            failed-tests-${{ github.run_id }}-

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - run: npm ci

      - name: Run Test
        run: |
          npm run test:ci -- $(test -e vitest_failed_testfiles.txt && cat vitest_failed_testfiles.txt)
      
      - name: Create failed tests file
        if: ${{ failure() && github.ref_name != 'main' }}
        run: |
          jq '.testResults[] | select(.status == "failed") | .name' vitest_result.json | jq -s --raw-output 'join(" ")' > vitest_failed_testfiles.txt
          cat vitest_failed_testfiles.txt
          
      - name: Save failed tests
        if: ${{ failure() && github.ref_name != 'main' }}
        uses: actions/cache/save@v4
        with:
          path: vitest_failed_testfiles.txt
          key: failed-tests-${{ github.run_id }}-${{ github.run_attempt }}

      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # not required for public repos
          directory: ./coverage/ # optional
          fail_ci_if_error: true # optional2 (default = false)

  node_pack:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_node_all == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - run: npm ci

      - name: Run build
        run: npm run build

      - name: Run pack
        run: npm pack

  renovate:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_renovate == 'true'
    steps:
      - uses: actions/checkout@v4

      - run: |
          npx --package renovate -c 'renovate-config-validator'

  required_jobs:
    runs-on: ubuntu-latest
    needs:
      - node_lint
      - node_test
      - node_pack
      - renovate
    if: always()
    steps:
      - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: |
          echo "Some required jobs failed or cancelled."
          exit 1

      - run: echo "All required jobs passed."
