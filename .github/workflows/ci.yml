name: CI

on:
  pull_request:
  push:
    branches:
      # Also run on main branch to have cache on default branch
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      changed_files_node_all: ${{ steps.changed_files.outputs.node_all_any_changed }}
      changed_files_node_lint: ${{ steps.changed_files.outputs.node_lint_any_changed }}
      changed_files_renovate: ${{ steps.changed_files.outputs.renovate_any_changed }}
    steps:
      - uses: actions/checkout@v4

      - name: Get all test, doc and src files that have changed
        id: changed_files
        uses: tj-actions/changed-files@0874344d6ebbaa00a27da73276ae7162fadcaf69 # v44
        with:
          files_yaml: |
            node_all:
              - tsconfig.json
              - package.json
              - package-lock.json
              - .tool-versions
              - src/**
            node_lint:
              - biome.json
            renovate:
              - renovate.json5

      - name: Display changed files
        run: |
          echo '${{ toJson(steps.changed_files.outputs) }}'
        
  node_lint:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_node_all == 'true' || needs.setup.outputs.changed_files_node_lint == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - run: npm ci

      - name: Run lint
        run: npm run lint

  node_test:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_node_all == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - run: npm ci

      - name: Run Test
        run: npm run test:coverage

      - uses: codecov/codecov-action@5ecb98a3c6b747ed38dc09f787459979aebb39be # v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # not required for public repos
          directory: ./coverage/ # optional
          fail_ci_if_error: true # optional2 (default = false)

  node_pack:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_node_all == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - run: npm ci

      - name: Run build
        run: npm run build

      - name: Run pack
        run: npm pack

  renovate:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.changed_files_renovate == 'true'
    steps:
      - uses: actions/checkout@v4

      - run: |
          npx --package renovate -c 'renovate-config-validator'

  required_jobs:
    runs-on: ubuntu-latest
    needs:
      - node_lint
      - node_test
      - node_pack
      - renovate
    if: always()
    steps:
      - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: |
          echo "Some required jobs failed or cancelled."
          exit 1

      - run: echo "All required jobs passed."
